# VSCode 拡張開発・環境構築（実務レベル・pnpm + esbuild）

## 1. 必要ツールのインストール
Node / VSCode / Yeoman / パッケージマネージャを最初に揃える。

### 必須
```bash
# Node.js LTS（推奨：nvm / nvm-windows）
nvm install lts
nvm use lts

# パッケージマネージャ（推奨：pnpm）
npm install -g pnpm

# Yeoman + VSCode Extension Generator
npm install -g yo generator-code
```

---

## 2. プロジェクト生成

```bash
# プロジェクトを作成したいディレクトリで実行
yo code
```

推奨選択肢：

- **What type of extension?**: New Extension (TypeScript)
- **Extension name**: (プロジェクト名を入力)
- **Identifier**: (そのままEnter)
- **Description**: (任意)
- **Initialize a git repository?**: Yes
- **Which bundler to use?**: **esbuild**
- **Which package manager to use?**: **pnpm**

**重要**: `yo code`は指定したプロジェクト名でサブディレクトリを作成します。

```bash
# 例: プロジェクト名を "my-extension" とした場合
parent-dir/
└─ my-extension/  ← ここにプロジェクトが生成される
    ├─ src/
    ├─ package.json
    └─ ...
```

生成される構造（完全版）：
```text
my-extension/
├─ .vscode/
│   ├─ extensions.json
│   ├─ launch.json      # F5デバッグ設定
│   ├─ settings.json
│   └─ tasks.json
├─ src/
│   ├─ extension.ts     # メインエントリーポイント
│   └─ test/
│       └─ extension.test.ts
├─ package.json         # scripts, contributes含む
├─ tsconfig.json
├─ esbuild.js          # ビルド設定
├─ eslint.config.mjs
├─ .vscode-test.mjs    # テスト設定
└─ .vscodeignore
```

---

## 3. 依存ライブラリのインストール

**重要**: 必ず生成されたプロジェクトディレクトリ内で実行してください。

```bash
# プロジェクトディレクトリに移動
cd my-extension

# 依存関係をインストール
pnpm install
```

`yo code`が自動的に以下を`package.json`に追加します：

```json
{
  "devDependencies": {
    "@types/vscode": "^1.x.x",
    "@types/mocha": "^10.x.x",
    "@types/node": "22.x",
    "@vscode/test-cli": "^0.0.x",
    "@vscode/test-electron": "^2.x.x",
    "esbuild": "^0.27.0",
    "eslint": "^9.x.x",
    "typescript": "^5.x.x",
    "typescript-eslint": "^8.x.x",
    "npm-run-all": "^4.x.x"
  }
}
```

追加の開発依存が必要な場合のみ：

```bash
pnpm add -D <パッケージ名>
```

---

## 4. デバッグ方法

VSCode でプロジェクトを開き、**F5** キーを押すと Extension Development Host が起動。

```bash
# VSCodeでプロジェクトを開く
code my-extension

# または既に開いている場合は F5 キーを押す
```

`.vscode/launch.json` が自動生成されているため、追加設定は不要。

---

## 5. `package.json` の理解（最重要）

生成される`package.json`には以下の重要なセクションがあります：

### scripts（重要！）

```json
{
  "scripts": {
    "vscode:prepublish": "pnpm run package",
    "compile": "pnpm run check-types && pnpm run lint && node esbuild.js",
    "watch": "npm-run-all -p watch:*",
    "watch:esbuild": "node esbuild.js --watch",
    "watch:tsc": "tsc --noEmit --watch --project tsconfig.json",
    "package": "pnpm run check-types && pnpm run lint && node esbuild.js --production",
    "compile-tests": "tsc -p . --outDir out",
    "watch-tests": "tsc -p . -w --outDir out",
    "pretest": "pnpm run compile-tests && pnpm run compile && pnpm run lint",
    "check-types": "tsc --noEmit",
    "lint": "eslint src",
    "test": "vscode-test"
  }
}
```

**主要コマンド**:
- `pnpm compile` - TypeScriptをコンパイル（開発用）
- `pnpm watch` - ファイル変更を監視して自動コンパイル
- `pnpm test` - テストを実行
- `pnpm package` - 本番用にビルド（最適化あり）

### contributes

拡張機能がVSCodeに提供する機能を定義：

```json
{
  "contributes": {
    "commands": [
      {
        "command": "test1.helloWorld",
        "title": "Hello World"
      }
    ]
  }
}
```

### activationEvents（現在は自動）

最新の`yo code`では`"activationEvents": []`が空になっており、
コマンド実行時に自動的にアクティベートされます。

---

## 6. テスト環境（vscode-test）

### テストの実行

**重要**: プロジェクトのルートディレクトリで実行してください。

```bash
# プロジェクトルートにいることを確認
pwd  # Windowsの場合: cd

# テスト実行
pnpm test
```

### 正常時の出力例

```
> test1@0.0.1 pretest
> pnpm run compile-tests && pnpm run compile && pnpm run lint

> test1@0.0.1 compile-tests
> tsc -p . --outDir out

> test1@0.0.1 compile
> pnpm run check-types && pnpm run lint && node esbuild.js

[watch] build started
[watch] build finished

> test1@0.0.1 test
> vscode-test

Extension Test Suite
  ✔ Sample test
1 passing (69ms)

Exit code: 0
```

### テストの仕組み

1. **pretest**: 自動的に実行される
   - `compile-tests`: テストコードをコンパイル
   - `compile`: 拡張機能本体をコンパイル
   - `lint`: ESLintでコードチェック

2. **test**: `vscode-test`を実行
   - VSCodeのテスト用インスタンスを起動
   - `src/test/extension.test.ts`を実行
   - Mochaテストフレームワークを使用

---

## 7. パッケージング（配布用）

配布用の `.vsix` を作成する方法：

```bash
# 1) pnpm dlx 実行（推奨）
pnpm dlx @vscode/vsce package

# 2) npx 実行
npx @vscode/vsce package

# 3) グローバルインストール
npm install -g @vscode/vsce
vsce package
```

生成された `.vsix` ファイルは VSCode で直接インストール可能：
- `Ctrl+Shift+P` → "Extensions: Install from VSIX..."

---

## 8. 実務向けフォルダ構成（推奨）

プロジェクトが大きくなってきたら以下の構成を検討：

```text
my-extension/
├─ src/
│   ├─ extension.ts          # エントリーポイント
│   ├─ commands/             # コマンド実装
│   │   ├─ helloWorld.ts
│   │   └─ index.ts
│   ├─ services/             # ビジネスロジック
│   ├─ providers/            # TreeDataProvider等
│   ├─ utils/                # ユーティリティ関数
│   └─ test/
│       └─ extension.test.ts
├─ out/                      # コンパイル済みテストコード
├─ dist/                     # esbuildの出力先
├─ .vscode/
├─ package.json
├─ tsconfig.json
└─ eslint.config.mjs
```

---

## 9. トラブルシューティング

### `pnpm test` で何も出力されない

**原因**: `package.json`に`scripts`セクションが無い、または間違ったディレクトリで実行している。

**確認方法**:
```bash
# 1. 現在のディレクトリを確認
pwd  # Windowsの場合: cd

# 2. package.jsonの存在とscriptsの確認
cat package.json | grep -A 5 '"scripts"'
# Windowsの場合: type package.json
```

**解決方法**:
1. プロジェクトのルートディレクトリにいることを確認
2. `package.json`に`"test": "vscode-test"`が存在することを確認
3. 無い場合は`yo code`で生成し直すか、手動で追加

### ディレクトリ構造の間違い

**よくある間違い**:
```text
parent-dir/
├─ package.json  ← 不完全（scriptsが無い）
└─ my-extension/
    ├─ package.json  ← 完全な設定
    └─ src/
```

この場合、`parent-dir`ではなく`my-extension`で作業する必要があります。

### テストが失敗する

```bash
# 依存関係を再インストール
rm -rf node_modules pnpm-lock.yaml
pnpm install

# コンパイルエラーを確認
pnpm run check-types
pnpm run lint
```

---

## 10. よく詰むポイント

### 1. ディレクトリ構造の理解不足
- `yo code`が生成したプロジェクトディレクトリの**中**で作業する
- `pnpm test`などのコマンドは必ずプロジェクトルートで実行

### 2. package.json の理解不足
- `contributes`セクションを理解せずすべて`extension.ts`に書いて破綻
- `scripts`が無いまま開発を進めてしまう

### 3. 設計面
- 状態管理（Memento API）を使わず独自永続化してバグる
- TreeView / WebView を軽く見て設計が瓦解
- テストを後回しにして機能膨張後に破綻

### 4. デバッグ
- F5 でデバッグできることを知らずconsole.logで頑張る
- Extension Development Host の使い方を理解していない

---

## 11. 学習優先度（API）

VSCode Extension APIの学習優先度：

### 初級（まずここから）
1. **Commands** - コマンドの登録と実装
2. **window.showInformationMessage** - 通知表示
3. **window.showQuickPick** - 選択肢UI
4. **workspace.getConfiguration** - 設定の読み書き

### 中級
5. **StatusBarItem** - ステータスバー表示
6. **OutputChannel** - 出力パネル
7. **TreeDataProvider** - サイドバーのツリービュー
8. **Memento** - 状態の永続化（`globalState` / `workspaceState`）

### 上級
9. **WebView** - カスタムHTMLビュー
10. **FileSystem API** - ファイル操作
11. **Language Server Protocol** - 言語サポート
12. **Debugging API** - デバッガー拡張

---

## 12. 開発ロードマップ（推奨）

### ステップ1: 基礎（1-2日）
- [ ] `yo code`でプロジェクト生成
- [ ] `pnpm install`で依存関係インストール
- [ ] F5でデバッグ実行を確認
- [ ] `pnpm test`でテスト実行を確認
- [ ] サンプルコマンドの動作確認

### ステップ2: 機能追加（3-5日）
- [ ] コマンドを3-5個追加実装
- [ ] `package.json`の`contributes`を理解
- [ ] 設定項目（Configuration）を追加
- [ ] StatusBarItemで情報表示

### ステップ3: 応用（1週間-）
- [ ] TreeDataProviderでサイドバー実装
- [ ] Memento APIで状態永続化
- [ ] WebViewでカスタムUI
- [ ] テストカバレッジを拡充

### ステップ4: 本番化
- [ ] エラーハンドリングの徹底
- [ ] ユーザー向けドキュメント作成（README.md）
- [ ] `pnpm package`でビルド確認
- [ ] マーケットプレイスに公開（任意）

---

## 13. 参考リソース

- [公式ドキュメント](https://code.visualstudio.com/api)
- [Extension API](https://code.visualstudio.com/api/references/vscode-api)
- [Extension Samples](https://github.com/microsoft/vscode-extension-samples)
- [公開ガイド](https://code.visualstudio.com/api/working-with-extensions/publishing-extension)
